<html>
    <head>
        <title>ol3 - Ex7c - Styling function</title>
        <meta charset="UTF-8">
        <script type="text/javascript" src="js/config.js"></script>
        <link rel="stylesheet" href="lib/layerswitcher/ol3-layerswitcher.css" type="text/css">
        <link rel="stylesheet" href="https://openlayers.org/en/v5.3.0/css/ol.css" type="text/css">
        <link rel="stylesheet" href="css/popupCss.css" type="text/css">
        <script src="lib/layerswitcher/ol3-layerswitcher.js" type="text/javascript"></script>
        <script src="js/cartoDB.js" type="text/javascript"></script>
        <script src="js/style.js" type="text/javascript"></script>
        <script type="text/javascript">
        
            var map;

            let OSM_layer = new ol.layer.Tile({

                            source: new ol.source.OSM(),
                            title: "OpenStreetMaps",
                            type: "base",
                            
                        });

            let Bing_layer = new ol.layer.Tile({
                            title: "Bing",
                            type: "base",
                            source: new ol.source.BingMaps({
                            key: 'AqE05oJsq-bWa50FPOW2S0eQm9Oqqygc1VTi_WPhUIoKR_-jgA559CRbfndgWAIz',
                            imagerySet: 'Aerial'
                            })
                        });

           //Vector layers

            let ARRETS_TPG = new ol.layer.Vector({
                title: "Arrêt TPG",
                source: new ol.source.Vector({
                    url: "https://audreyhuguenin.carto.com/api/v2/sql?format=GeoJSON&q=select%20cartodb_id,%20the_geom,%20nom_arret,%20ligne,%20direction%20from%20public.tpg_arrets",
                    format: new ol.format.GeoJSON()
                }),
                style: new ol.style.Style({
                        image: new ol.style.Icon({
                        src: "./img/TPG.png",
                        anchor:  [0.5, 0.5],
                        scale:0.018})
                    })
            });


            let installations_sportive = new ol.layer.Vector({
                title:"Installation sportive",
                source: new ol.source.Vector({
                    url: "https://audreyhuguenin.carto.com:443/api/v2/sql?format=GeoJSON&q=select%20*%20from%20public.instsport_ext",
                    format: new ol.format.GeoJSON()
                }),
                style: instSportStyle
              
            });

            console.log(installations_sportive);

            let velo_itinairaire = new ol.layer.Tile({
                source: cartoDBSource3,
                title: "Itinéraire de vélo"
            });

            

            let ZONES_loisirs = new ol.layer.Tile({
                    source: cartoDBSource7,
                    title: "Itinéraires loisirs divers"
            });

            // layer tiles

            let WC = new ol.layer.Tile({
                source: cartoDBSource2,
                title: "WC Genève"
            });

            let Equipement_plages = new ol.layer.Tile({
                source: cartoDBSource5,
                title: "Equipements plages (WC/douches)"
            });

            let Pollution_Air = new ol.layer.Tile({
                source: cartoDBSource6,
                title: "Pollution de l'air (voir légende)"
            });

            console.log(installations_sportive);
/*

            function chooseSport(n) {

                console.log(mapConfig4);
                mapConfig4.layers[0].options.sql =
                    'select * from instsport_ext where categorie1 == ' + n;
            }
*/


$(document).ready(function () {

/*                document.getElementById('categorie-sport').addEventListener('change', function() {
                    chooseSport(this.value);
                });*/

                map = new ol.Map({
                    view: new ol.View({
                        center:[710000, 5840171],
                        zoom: 10
                    }),
                    target: 'map',
                    layers: [
                        new ol.layer.Group({
                            title: 'Maps',
                            layers: [
                                OSM_layer,
                                Bing_layer,
                            ]
                        }),
                        new ol.layer.Group({
                            title: 'Data tiles',
                            layers: [
                                WC,
                                Equipement_plages,
                                Pollution_Air
                            ]
                        }),
                        new ol.layer.Group({
                            title: 'Data Vector',
                            layers: [
                                ARRETS_TPG,
                                velo_itinairaire,
                                installations_sportive,
                                ZONES_loisirs
                            ]
                        })
                    ],
                    target: 'map'                
                });

                map.getView().setCenter(ol.proj.transform([6.1667, 46.2], "EPSG:4326", "EPSG:3857"));
                map.getView().setZoom(13);
                
                var layerSwitcher = new ol.control.LayerSwitcher();
                map.addControl(layerSwitcher);

//interaction Arrêts TPG
                var selectInteractionTPG = new ol.interaction.Select({
                    condition: ol.events.condition.click,
                    // the interactive layers on which the selection is possible (they may be more than one)
                    layers: [ARRETS_TPG, installations_sportive],
                    style: selectedStyle  
                });
                map.addInteraction(selectInteractionTPG);

                // add a listener to fire when one or more feature from the interactive layer(s) is(are) selected
                selectInteractionTPG.on('select', function (e) 
                {
                    console.log(e);
                    if(e.selected.length > 0) 
                    {
                        //si c'est une installations sportive
                        if(e.selected[0].values_.categorie1!=undefined)
                        {

                        var sport = e.selected[0].get("sport");
                        var equipement = e.selected[0].get("nom_equipe");
                        var commune = e.selected[0].get("commune");
                        var photos = e.selected[0].get("photos");
                        var ficheEquipe = e.selected[0].get("fiche_equi");
                        $("#info").html("Sport: "+sport+"<br> Equipement: "+ equipement+"<br>Commune: "+commune+"<br>Photos: <a href='"+photos+"'>"
                        +photos+"</a><br>Fiche de l'équipement: <a href='"+ficheEquipe+"'>"+ficheEquipe+"</a>");
                        }
                        //si c'est un arret TPG
                        else if(e.selected[0].values_.direction!=undefined)
                        {
                        var nom_arret = e.selected[0].get("nom_arret");
                        var ligne = e.selected[0].get("ligne");
                        var directions = e.selected[0].get("direction");
                        $("#info").html("Arrêt: "+nom_arret+"<br> Ligne: "+ ligne+"<br>Directions: "+directions);
                        }
                        else
                        {
                            // A CHANGER!!
                        var nom_arret = e.selected[0].get("nom_arret");
                        var ligne = e.selected[0].get("ligne");
                        var directions = e.selected[0].get("direction");
                        $("#info").html("Arrêt: "+nom_arret+"<br> Ligne: "+ ligne+"<br>Directions: "+directions);
                        }
                        
                    }
                    else
                    {
                        $("#info").html("Sélectionnez un élément sur la carte");
                    }
                });       

            });
                    

        </script>
        <style type="text/css">
            #map {
                width: 100%;
                height: 100%;
            }
            #info {
                position: absolute;
                top: 20px;
                left: 60px;
                background-color: rgba(0, 0, 10, 0.7);
                border-radius: 10px;
                padding: 8px;
                z-index: 1000000000;
                font-family: Arial, Helvetica, sans-serif;
                font-size: 14px;
                font-weight: 400;
                color: white;
            }
        </style>
    </head>
    <body>
        <div id="map">
<!--            <div class="row-fluid">
                <div >
                    <div>
                        <form class="form-horizontal">
                            <label>
                                Montrer les installations sportives de:
                                <select id="categorie-sport" class="form-control">
                                    <option value="terrain">terrain</option>
                                    <option value="court">court</option>
                                    <option value="aquatique">aquatique</option>
                                    <option value="promenades">promenades</option>
                                </select>
                            </label>
                        </form>
                    </div>
                </div>
            </div>-->
        </div>
        <div id="info"></div>
    </body>
</html>